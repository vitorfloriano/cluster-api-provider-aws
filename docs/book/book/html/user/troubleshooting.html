<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Troubleshooting - Kubernetes Cluster API Provider AWS</title>
        
        


        <!-- Custom HTML head -->
        <link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Lato:ital,wght@0,400;0,700;1,400;1,700&display=swap"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<meta name="google-site-verification" content="FGwibyytASqneHUQBmwzN0eOO3-Nd_coIx2YlbhzzSM" />


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../user/quick-start.html">Quick Start</a></li><li class="chapter-item expanded "><a href="../user/quick-start-operator.html">Quick Start Operator</a></li><li class="chapter-item expanded "><a href="../topics/images/amis.html">AMIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/images/built-amis.html">Published AMIs</a></li><li class="chapter-item expanded "><a href="../topics/images/custom-amis.html">Custom AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/index.html">Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/using-clusterawsadm-to-fulfill-prerequisites.html">Using clusterawsadm to fulfill prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/accessing-ec2-instances.html">Accessing EC2 instances</a></li><li class="chapter-item expanded "><a href="../topics/spot-instances.html">Spot instances</a></li><li class="chapter-item expanded "><a href="../topics/machinepools.html">Machine Pools</a></li><li class="chapter-item expanded "><a href="../topics/multitenancy.html">Multi-tenancy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/full-multitenancy-implementation.html">Multi-tenancy in EKS-managed clusters</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/eks/index.html">EKS Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/eks/prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/eks/enabling.html">Enabling EKS Support</a></li><li class="chapter-item expanded "><a href="../topics/eks/pod-networking.html">Pod Networking</a></li><li class="chapter-item expanded "><a href="../topics/eks/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/eks/disabling.html">Disabling</a></li><li class="chapter-item expanded "><a href="../topics/eks/eks-console.html">Using EKS Console</a></li><li class="chapter-item expanded "><a href="../topics/eks/addons.html">Using EKS Addons</a></li><li class="chapter-item expanded "><a href="../topics/eks/encryption.html">Enabling Encryption</a></li><li class="chapter-item expanded "><a href="../topics/eks/cluster-upgrades.html">Cluster Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/rosa/index.html">ROSA Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/rosa/enabling.html">Enabling ROSA Support</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-rosa-machinepools.html">Creating MachinePools</a></li><li class="chapter-item expanded "><a href="../topics/rosa/upgrades.html">Upgrades</a></li><li class="chapter-item expanded "><a href="../topics/rosa/external-auth.html">External Auth Providers</a></li><li class="chapter-item expanded "><a href="../topics/rosa/support.html">Support</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/bring-your-own-aws-infrastructure.html">Bring Your Own AWS Infrastructure</a></li><li class="chapter-item expanded "><a href="../topics/specify-management-iam-role.html">Specifying the IAM Role to use for Management Components</a></li><li class="chapter-item expanded "><a href="../topics/external-cloud-provider-with-ebs-csi-driver.html">Using external cloud provider with EBS CSI driver</a></li><li class="chapter-item expanded "><a href="../topics/restricting-cluster-api-to-certain-namespaces.html">Restricting Cluster API to certain namespaces</a></li><li class="chapter-item expanded "><a href="../topics/using-iam-roles-in-mgmt-cluster.html">Using IAM roles in management cluster instead of credentials</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/index.html">Failure domains</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/failure-domains/control-planes.html">Control planes</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/worker-nodes.html">Worker nodes</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/userdata-privacy.html">Userdata Privacy</a></li><li class="chapter-item expanded "><a href="../user/troubleshooting.html" class="active">Troubleshooting</a></li><li class="chapter-item expanded "><a href="../topics/iam-permissions.html">IAM Permissions Used</a></li><li class="chapter-item expanded "><a href="../topics/ignition-support.html">Ignition support</a></li><li class="chapter-item expanded "><a href="../topics/external-resource-gc.html">External Resource Garbage Collection</a></li><li class="chapter-item expanded "><a href="../topics/instance-metadata.html">Instance Metadata</a></li><li class="chapter-item expanded "><a href="../topics/network-load-balancer-with-awscluster.html">Network Load Balancers</a></li><li class="chapter-item expanded "><a href="../topics/secondary-load-balancer.html">Secondary Control Plane Load Balancer</a></li><li class="chapter-item expanded "><a href="../topics/provision-edge-zones.html">Provision AWS Local Zone subnets</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm.html">clusterawsadm command reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap.html">bootstrap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials.html">credentials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials_encode-as-profile.html">encode-as-profile</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam.html">iam</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-policy.html">print-policy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_create-cloudformation-stack.html">create-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_delete-cloudformation-stack.html">delete-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-cloudformation-template.html">print-cloudformation-template</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-config.html">print-config</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller.html">controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_print-credentials.html">print-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_rollout-controller.html">rollout-controller</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_update-credentials.html">update-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_zero-credentials.html">zero-credentials</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks.html">eks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons.html">addons</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-available.html">list-available</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-installed.html">list-installed</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc.html">gc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_configure.html">configure</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_disable.html">disable</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_enable.html">enable</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource.html">resource</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource_list.html">list</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_version.html">version</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami.html">ami</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_copy.html">copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_encrypted-copy.html">encrypted-copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_list.html">list</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../development/development.html">Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development/tilt-setup.html">Development with Tilt</a></li><li class="chapter-item expanded "><a href="../development/e2e.html">Developing E2E tests</a></li><li class="chapter-item expanded "><a href="../development/conventions.html">Coding Conventions</a></li><li class="chapter-item expanded "><a href="../development/nightlies.html">Try unreleased changes with Nightly Builds</a></li><li class="chapter-item expanded "><a href="../development/amis.html">Publishing AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../crd/index.html">CRD Reference</a></li><li class="chapter-item expanded "><a href="../topics/reference/reference.html">Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reference/glossary.html">Glossary</a></li><li class="chapter-item expanded "><a href="../topics/reference/ports.html">Ports</a></li><li class="chapter-item expanded "><a href="../topics/reference/jobs.html">Jobs</a></li><li class="chapter-item expanded "><a href="../topics/reference/versions.html">Version Support</a></li><li class="chapter-item expanded "><a href="../topics/reference/contributing.html">Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="../roadmap.html">Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Kubernetes Cluster API Provider AWS</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://sigs.k8s.io/cluster-api-provider-aws" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#troubleshooting" id="troubleshooting">Troubleshooting</a></h1>
<h2><a class="header" href="#resources-arent-being-created" id="resources-arent-being-created">Resources aren’t being created</a></h2>
<p>TODO</p>
<h2><a class="header" href="#target-clusters-control-plane-machine-is-up-but-target-clusters-apiserver-not-working-as-expected" id="target-clusters-control-plane-machine-is-up-but-target-clusters-apiserver-not-working-as-expected">Target cluster’s control plane machine is up but target cluster’s apiserver not working as expected</a></h2>
<p>If <code>aws-provider-controller-manager-0</code> logs did not help, you might want to look into cloud-init logs, <code>/var/log/cloud-init-output.log</code>, on the controller host.
Verifying kubelet status and logs may also provide hints:</p>
<pre><code class="language-bash">journalctl -u kubelet.service
systemctl status kubelet
</code></pre>
<p>For reaching controller host from your local machine:</p>
<pre><code class="language-bash"> ssh -i &lt;private-key&gt; -o &quot;ProxyCommand ssh -W %h:%p -i &lt;private-key&gt; ubuntu@&lt;bastion-IP&gt;&quot; ubuntu@&lt;controller-host-IP&gt;
</code></pre>
<p><code>private-key</code> is the private key from the key-pair discussed in the <code>ssh key pair</code> section above.</p>
<h2><a class="header" href="#kubelet-on-the-control-plane-host-failing-with-error-nocredentialproviders" id="kubelet-on-the-control-plane-host-failing-with-error-nocredentialproviders">kubelet on the control plane host failing with error: NoCredentialProviders</a></h2>
<pre><code class="language-bash">failed to run Kubelet: could not init cloud provider &quot;aws&quot;: error finding instance i-0c276f2a1f1c617b2: &quot;error listing AWS instances: \&quot;NoCredentialProviders: no valid providers in chain. Deprecated.\\n\\tFor verbose messaging see aws.Config.CredentialsChainVerboseErrors\&quot;&quot;
</code></pre>
<p>This error can occur if <code>CloudFormation</code> stack is not created properly and IAM instance profile is missing appropriate roles. Run following command to inspect IAM instance profile:</p>
<pre><code class="language-bash">$ aws iam get-instance-profile --instance-profile-name control-plane.cluster-api-provider-aws.sigs.k8s.io --output json
{
    &quot;InstanceProfile&quot;: {
        &quot;InstanceProfileId&quot;: &quot;AIPAJQABLZS4A3QDU576Q&quot;,
        &quot;Roles&quot;: [
            {
                &quot;AssumeRolePolicyDocument&quot;: {
                    &quot;Version&quot;: &quot;2012-10-17&quot;,
                    &quot;Statement&quot;: [
                        {
                            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
                            &quot;Effect&quot;: &quot;Allow&quot;,
                            &quot;Principal&quot;: {
                                &quot;Service&quot;: &quot;ec2.amazonaws.com&quot;
                            }
                        }
                    ]
                },
                &quot;RoleId&quot;: &quot;AROAJQABLZS4A3QDU576Q&quot;,
                &quot;CreateDate&quot;: &quot;2019-05-13T16:45:12Z&quot;,
                &quot;RoleName&quot;: &quot;control-plane.cluster-api-provider-aws.sigs.k8s.io&quot;,
                &quot;Path&quot;: &quot;/&quot;,
                &quot;Arn&quot;: &quot;arn:aws:iam::123456789012:role/control-plane.cluster-api-provider-aws.sigs.k8s.io&quot;
            }
        ],
        &quot;CreateDate&quot;: &quot;2019-05-13T16:45:28Z&quot;,
        &quot;InstanceProfileName&quot;: &quot;control-plane.cluster-api-provider-aws.sigs.k8s.io&quot;,
        &quot;Path&quot;: &quot;/&quot;,
        &quot;Arn&quot;: &quot;arn:aws:iam::123456789012:instance-profile/control-plane.cluster-api-provider-aws.sigs.k8s.io&quot;
    }
}

</code></pre>
<p>If instance profile does not look as expected, you may try recreating the CloudFormation stack using <code>clusterawsadm</code> as explained in the above sections.</p>
<h2><a class="header" href="#recover-a-management-cluster-after-losing-the-api-server-load-balancer" id="recover-a-management-cluster-after-losing-the-api-server-load-balancer">Recover a management cluster after losing the api server load balancer</a></h2>
<p>These steps outline the process for recovering a management cluster after losing the load balancer for the api server. These steps are needed because AWS load balancers have dynamically generated DNS names. This means that when a load balancer is deleted CAPA will recreate the load balancer but it will have a different DNS name that does not match the original, so we need to update some resources as well as the certs to match the new name to make the cluster healthy again. There are a few different scenarios which this could happen.</p>
<ul>
<li>The load balancer gets deleted by some external process or user.</li>
<li>If a cluster is created with the same name as the management cluster in a different namespace and then deleted it will delete the existing load balancer. This is due to ownership of AWS resources being managed by tags. See this <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/issues/969#issuecomment-519121056">issue</a> for reference.</li>
</ul>
<h3><a class="header" href="#access-the-api-server-locally" id="access-the-api-server-locally"><strong>Access the api server locally</strong></a></h3>
<ol>
<li>
<p>ssh to a control plane node and modify the <code>/etc/kubernetes/admin.conf</code></p>
<ul>
<li>
<p>Replace the <code>server</code> with <code>server: https://localhost:6443</code></p>
</li>
<li>
<p>Add <code>insecure-skip-tls-verify: true</code></p>
</li>
<li>
<p>Comment out <code>certificate-authority-data:</code></p>
</li>
</ul>
</li>
<li>
<p>Export the kubeconfig and ensure you can connect</p>
<pre><code class="language-bash">export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl get nodes
</code></pre>
</li>
</ol>
<h3><a class="header" href="#get-rid-of-the-lingering-duplicate-cluster" id="get-rid-of-the-lingering-duplicate-cluster"><strong>Get rid of the lingering duplicate cluster</strong></a></h3>
<p><strong>This step is only needed in the scenario that duplicate cluster was created and deleted which caused the API server load balancer to be deleted.</strong></p>
<ol>
<li>
<p>since there is a duplicate cluster that is trying to be deleted and can’t due to some resources being unable to cleanup since they are in use we need to stop the conflicting reconciliation process. Edit the duplicate aws cluster object and remove the <code>finalizers</code></p>
<pre><code class="language-bash">kubectl edit awscluster &lt;clustername&gt;
</code></pre>
</li>
<li>
<p>next run <code>kubectl describe awscluster &lt;clustername&gt;</code> to validate that the finalizers have been removed</p>
</li>
<li>
<p><code>kubectl get clusters</code> to verify the cluster is gone</p>
</li>
</ol>
<h3><a class="header" href="#make-at-least-one-node-ready" id="make-at-least-one-node-ready"><strong>Make at least one node <code>Ready</code></strong></a></h3>
<ol>
<li>
<p>Right now all endpoints are down due to nodes not being ready. this is problematic for coredns adn cni pods in particular. let’s get one control plane node back healthy. on the control plane node we logged into edit the <code>/etc/kubernetes/kubelet.conf</code></p>
<ul>
<li>
<p>Replace the <code>server</code> with <code>server: https://localhost:6443</code></p>
</li>
<li>
<p>Add <code>insecure-skip-tls-verify: true</code></p>
</li>
<li>
<p>Comment out <code>certificate-authority-data:</code></p>
</li>
<li>
<p>Restart the kubelet <code>systemctl restart kubelet</code></p>
</li>
</ul>
</li>
<li>
<p><code>kubectl get nodes</code> and validate that the node is in a  ready state.</p>
</li>
<li>
<p>After a few minutes most things should start scheduling themselves on the new node. The pods that did not restart on their own that were causing issues were core-dns,kube-proxy, and cni pods.Those should be restart manually.</p>
</li>
<li>
<p>(optional) tail the capa logs to see the load balancer start to reconcile</p>
<pre><code class="language-bash">kubectl logs -f -n capa-system deployments.apps/capa-controller-manager`
</code></pre>
</li>
</ol>
<h3><a class="header" href="#update-the-control-plane-nodes-with-new-lb-settings" id="update-the-control-plane-nodes-with-new-lb-settings"><strong>Update the control plane nodes with new LB settings</strong></a></h3>
<ol>
<li>
<p>To be safe we will do this on all CP nodes rather than having them recreate to avoid potential data loss issues. Follow the following steps for <strong>each</strong> CP node.</p>
</li>
<li>
<p>Regenrate the certs for the api server using the new name. Make sure to update your service cidr and endpoint in the below command.</p>
<pre><code class="language-bash">rm /etc/kubernetes/pki/apiserver.crt
rm /etc/kubernetes/pki/apiserver.key

kubeadm init phase certs apiserver --control-plane-endpoint=&quot;mynewendpoint.com&quot; --service-cidr=100.64.0.0/13 -v10
</code></pre>
</li>
<li>
<p>Update settings in <code>/etc/kubernetes/admin.conf</code></p>
<ul>
<li>
<p>Replace the <code>server</code> with <code>server: https://&lt;your-new-lb.com&gt;:6443</code></p>
</li>
<li>
<p>Remove <code>insecure-skip-tls-verify: true</code></p>
</li>
<li>
<p>Uncomment <code>certificate-authority-data:</code></p>
</li>
<li>
<p>Export the kubeconfig and ensure you can connect </p>
<pre><code class="language-bash">export KUBECONFIG=/etc/kubernetes/admin.conf
kubectl get nodes
</code></pre>
</li>
</ul>
</li>
<li>
<p>Update the settings in <code>/etc/kubernetes/kubelet.conf</code></p>
<ul>
<li>
<p>Replace the <code>server</code> with <code>server: https://your-new-lb.com:6443</code></p>
</li>
<li>
<p>Remove <code>insecure-skip-tls-verify: true</code></p>
</li>
<li>
<p>Uncomment <code>certificate-authority-data:</code></p>
</li>
<li>
<p>restart the kubelet <code>systemctl restart kubelet</code></p>
</li>
</ul>
</li>
<li>
<p>Just as we did before we need new pods to pick up api server cache changes so  you will want to force restart pods like cni pods, kube-proxy, core-dns , etc.</p>
</li>
</ol>
<h3><a class="header" href="#update-capi-settings-for-new-lb-dns-name" id="update-capi-settings-for-new-lb-dns-name">Update capi settings for new LB DNS name</a></h3>
<ol>
<li>
<p>Update the control plane endpoint on the <code>awscluster</code> and <code>cluster</code> objects. To do this we need to disable the validatingwebhooks. We will back them up and then delete so we can apply later.</p>
<pre><code class="language-bash">kubectl get validatingwebhookconfigurations capa-validating-webhook-configuration -o yaml &gt; capa-webhook &amp;&amp; kubectl delete validatingwebhookconfigurations capa-validating-webhook-configuration

kubectl get validatingwebhookconfigurations capi-validating-webhook-configuration -o yaml &gt; capi-webhook &amp;&amp; kubectl delete validatingwebhookconfigurations capi-validating-webhook-configuration
</code></pre>
</li>
<li>
<p>Edit the <code>spec.controlPlaneEndpoint.host</code> field on both <code>awscluster</code> and <code>cluster</code> to have the new endpoint</p>
</li>
<li>
<p>Re-apply your webhooks</p>
<pre><code class="language-bash">kubectl apply -f capi-webhook
kubectl apply -f capa-webhook
</code></pre>
</li>
<li>
<p>Update the following config maps and replace the old control plane name with the new one.</p>
<pre><code class="language-bash">kubectl edit cm -n kube-system kubeadm-config
kubectl edit cm -n kube-system kube-proxy
kubectl edit cm -n kube-public cluster-info
</code></pre>
</li>
<li>
<p>Edit the cluster kubeconfig secret that capi uses to talk to the management cluster. You will need to decode teh secret, replace the endpoint and re-encode and save.</p>
<pre><code class="language-bash">kubectl edit secret -n &lt;namespace&gt; &lt;cluster-name&gt;-kubeconfig`
</code></pre>
</li>
<li>
<p>At this point things should start to reconcile on their own, but we can use the commands in the next step to force it. </p>
</li>
</ol>
<h3><a class="header" href="#roll-all-of-the-nodes-to-make-sure-everything-is-fresh" id="roll-all-of-the-nodes-to-make-sure-everything-is-fresh">Roll all of the nodes to make sure everything is fresh</a></h3>
<ol>
<li>
<pre><code class="language-bash">kubectl patch kcp &lt;clusternamekcp&gt; -n namespace --type merge -p &quot;{\&quot;spec\&quot;:{\&quot;rolloutAfter\&quot;:\&quot;`date +'%Y-%m-%dT%TZ'`\&quot;}}&quot;
</code></pre>
</li>
<li>
<pre><code class="language-bash"> kubectl patch machinedeployment CLUSTER_NAME-md-0 -n namespace --type merge -p &quot;{\&quot;spec\&quot;:{\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;annotations\&quot;:{\&quot;date\&quot;:\&quot;`date +'%s'`\&quot;}}}}}&quot;
</code></pre>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../topics/userdata-privacy.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../topics/iam-permissions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../topics/userdata-privacy.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../topics/iam-permissions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
