<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using external cloud provider with EBS CSI driver - Kubernetes Cluster API Provider AWS</title>
        
        


        <!-- Custom HTML head -->
        <link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Lato:ital,wght@0,400;0,700;1,400;1,700&display=swap"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<meta name="google-site-verification" content="FGwibyytASqneHUQBmwzN0eOO3-Nd_coIx2YlbhzzSM" />


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../user/quick-start.html">Quick Start</a></li><li class="chapter-item expanded "><a href="../quick-start-operator.html">Quick Start Operator</a></li><li class="chapter-item expanded "><a href="../topics/images/amis.html">AMIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/images/built-amis.html">Published AMIs</a></li><li class="chapter-item expanded "><a href="../topics/images/custom-amis.html">Custom AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/index.html">Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/using-clusterawsadm-to-fulfill-prerequisites.html">Using clusterawsadm to fulfill prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/accessing-ec2-instances.html">Accessing EC2 instances</a></li><li class="chapter-item expanded "><a href="../topics/spot-instances.html">Spot instances</a></li><li class="chapter-item expanded "><a href="../topics/machinepools.html">Machine Pools</a></li><li class="chapter-item expanded "><a href="../topics/multitenancy.html">Multi-tenancy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/full-multitenancy-implementation.html">Multi-tenancy in EKS-managed clusters</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/eks/index.html">EKS Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/eks/prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/eks/enabling.html">Enabling EKS Support</a></li><li class="chapter-item expanded "><a href="../topics/eks/pod-networking.html">Pod Networking</a></li><li class="chapter-item expanded "><a href="../topics/eks/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/eks/eks-console.html">Using EKS Console</a></li><li class="chapter-item expanded "><a href="../topics/eks/addons.html">Using EKS Addons</a></li><li class="chapter-item expanded "><a href="../topics/eks/encryption.html">Enabling Encryption</a></li><li class="chapter-item expanded "><a href="../topics/eks/cluster-upgrades.html">Cluster Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/rosa/index.html">ROSA Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/rosa/enabling.html">Enabling ROSA Support</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-rosa-machinepools.html">Creating MachinePools</a></li><li class="chapter-item expanded "><a href="../topics/rosa/upgrades.html">Upgrades</a></li><li class="chapter-item expanded "><a href="../topics/rosa/external-auth.html">External Auth Providers</a></li><li class="chapter-item expanded "><a href="../topics/rosa/support.html">Support</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/bring-your-own-aws-infrastructure.html">Bring Your Own AWS Infrastructure</a></li><li class="chapter-item expanded "><a href="../topics/specify-management-iam-role.html">Specifying the IAM Role to use for Management Components</a></li><li class="chapter-item expanded "><a href="../topics/external-cloud-provider-with-ebs-csi-driver.html" class="active">Using external cloud provider with EBS CSI driver</a></li><li class="chapter-item expanded "><a href="../topics/restricting-cluster-api-to-certain-namespaces.html">Restricting Cluster API to certain namespaces</a></li><li class="chapter-item expanded "><a href="../topics/using-iam-roles-in-mgmt-cluster.html">Using IAM roles in management cluster instead of credentials</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/index.html">Failure domains</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/failure-domains/control-planes.html">Control planes</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/worker-nodes.html">Worker nodes</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/userdata-privacy.html">Userdata Privacy</a></li><li class="chapter-item expanded "><a href="../topics/troubleshooting.html">Troubleshooting</a></li><li class="chapter-item expanded "><a href="../topics/iam-permissions.html">IAM Permissions Used</a></li><li class="chapter-item expanded "><a href="../topics/ignition-support.html">Ignition support</a></li><li class="chapter-item expanded "><a href="../topics/external-resource-gc.html">External Resource Garbage Collection</a></li><li class="chapter-item expanded "><a href="../topics/instance-metadata.html">Instance Metadata</a></li><li class="chapter-item expanded "><a href="../topics/network-load-balancer-with-awscluster.html">Network Load Balancers</a></li><li class="chapter-item expanded "><a href="../topics/secondary-load-balancer.html">Secondary Control Plane Load Balancer</a></li><li class="chapter-item expanded "><a href="../topics/provision-edge-zones.html">Provision AWS Local Zone subnets</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm.html">clusterawsadm command reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap.html">bootstrap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials.html">credentials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials_encode-as-profile.html">encode-as-profile</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam.html">iam</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-policy.html">print-policy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_create-cloudformation-stack.html">create-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_delete-cloudformation-stack.html">delete-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-cloudformation-template.html">print-cloudformation-template</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-config.html">print-config</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller.html">controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_print-credentials.html">print-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_rollout-controller.html">rollout-controller</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_update-credentials.html">update-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_zero-credentials.html">zero-credentials</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks.html">eks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons.html">addons</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-available.html">list-available</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-installed.html">list-installed</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc.html">gc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_configure.html">configure</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_disable.html">disable</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_enable.html">enable</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource.html">resource</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource_list.html">list</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_version.html">version</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami.html">ami</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_copy.html">copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_encrypted-copy.html">encrypted-copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_list.html">list</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../development/development.html">Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development/tilt-setup.html">Development with Tilt</a></li><li class="chapter-item expanded "><a href="../development/e2e.html">Developing E2E tests</a></li><li class="chapter-item expanded "><a href="../development/conventions.html">Coding Conventions</a></li><li class="chapter-item expanded "><a href="../development/nightlies.html">Try unreleased changes with Nightly Builds</a></li><li class="chapter-item expanded "><a href="../development/amis.html">Publishing AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../crd/index.html">CRD Reference</a></li><li class="chapter-item expanded "><a href="../topics/reference/reference.html">Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reference/glossary.html">Glossary</a></li><li class="chapter-item expanded "><a href="../topics/reference/ports.html">Ports</a></li><li class="chapter-item expanded "><a href="../topics/reference/jobs.html">Jobs</a></li><li class="chapter-item expanded "><a href="../topics/reference/versions.html">Version Support</a></li><li class="chapter-item expanded "><a href="../topics/reference/contributing.html">Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="../roadmap.html">Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Kubernetes Cluster API Provider AWS</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://sigs.k8s.io/cluster-api-provider-aws" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#external-aws-cloud-provider-and-aws-csi-driver" id="external-aws-cloud-provider-and-aws-csi-driver">External AWS Cloud Provider and AWS CSI Driver</a></h1>
<h2><a class="header" href="#overview" id="overview">Overview</a></h2>
<p>The support for in-tree cloud providers and the CSI drivers is coming to an end and CAPA supports various upgrade paths
to use <a href="https://github.com/kubernetes/cloud-provider-aws">external cloud provider (Cloud Controller Manager - CCM) </a> and external CSI drivers.
This document explains how to create a CAPA cluster with external CSI/CCM plugins and how to upgrade existing clusters that rely on in-tree providers.</p>
<h2><a class="header" href="#creating-clusters-with-external-csiccm-and-validating" id="creating-clusters-with-external-csiccm-and-validating">Creating clusters with external CSI/CCM and validating</a></h2>
<p>For clusters that will use external CCM, <code>cloud-provider: external</code> flag needs to be set in KubeadmConfig resources in both <code>KubeadmControlPlane</code> and <code>MachineDeployment</code> resources.</p>
<pre><code>clusterConfiguration:
  apiServer:
    extraArgs:
      cloud-provider: external
  controllerManager:
    extraArgs:
      cloud-provider: external
initConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: external
joinConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: external
</code></pre>
<p>External CCM and EBS CSI driver can be installed manually or using ClusterResourceSets (CRS) onto the CAPA workload cluster.
To install them with CRS, create a CRS resource on the management cluster with labels, for example <code>csi: external</code> and <code>ccm: external</code> labels.
Then, when creating <code>Cluster</code> objects for workload clusters that should have this CSR applied, create them with matching labels <code>csi: external</code> and <code>ccm: external</code> for CSI and CCM, respectively.</p>
<p>Manifests for installing the AWS CCM and the AWS EBS CSI driver are available from their respective
GitHub repositories (see <a href="https://github.com/kubernetes/cloud-provider-aws">here for the AWS CCM</a> and
<a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver">here for the AWS EBS CSI driver</a>).</p>
<p>An example of a workload cluster manifest with labels assigned for matching to a CRS can be found
<a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/tree/main/templates/cluster-template.yaml">here</a>.</p>
<h3><a class="header" href="#verifying-dynamically-provisioned-volumes-with-csi-driver" id="verifying-dynamically-provisioned-volumes-with-csi-driver">Verifying dynamically provisioned volumes with CSI driver</a></h3>
<p>Once you have the cluster with external CCM and CSI controller running successfully, you can test the CSI driver functioning with following steps after switching to workload cluster:</p>
<ol>
<li>Create a service (say,<code>nginx</code>)</li>
</ol>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
  namespace: default
spec:
  clusterIP: None
  ports:
    - name: nginx-web
      port: 80
  selector:
    app: nginx
</code></pre>
<ol start="2">
<li>Create a storageclass and statefulset for the service created above with the persistent volume assigned to the storageclass:</li>
</ol>
<pre><code class="language-yaml">kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: aws-ebs-volumes
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  csi.storage.k8s.io/fstype: xfs
  type: io1
  iopsPerGB: &quot;100&quot;
allowedTopologies:
  - matchLabelExpressions:
      - key: topology.ebs.csi.aws.com/zone
        values:
          - us-east-1a
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nginx-statefulset
spec:
  serviceName: &quot;nginx-svc&quot;
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: registry.k8s.io/nginx-slim:0.8
          ports:
            - name: nginx-web
              containerPort: 80
          volumeMounts:
            - name: nginx-volumes
              mountPath: /usr/share/nginx/html
      volumes:
        - name: nginx-volumes
          persistentVolumeClaim:
            claimName: nginx-volumes
  volumeClaimTemplates:
    - metadata:
        name: nginx-volumes
      spec:
        storageClassName: &quot;aws-ebs-volumes&quot;
        accessModes: [ &quot;ReadWriteOnce&quot; ]
        resources:
          requests:
            storage: 4Gi
</code></pre>
<ol start="3">
<li>Once you apply the above manifest, the EBS volumes will be created and attached to the worker nodes.</li>
</ol>
<blockquote>
<p><strong>IMPORTANT WARNING:</strong> The CRDs from the AWS EBS CSI driver and AWS external cloud provider gives issue while installing the respective controllers on the AWS Cluster, it doesnâ€™t allow statefulsets to create the volume on existing EC2 instance.
We need the CSI controller deployment and CCM pinned to the control plane which has right permissions to create, attach
and mount the volumes to EC2 instances. To achieve this, you should add the node affinity rules to the CSI driver controller deployment and CCM DaemonSet manifests.</p>
<pre><code class="language-yaml">tolerations:
- key: node-role.kubernetes.io/master
  effect: NoSchedule
- effect: NoSchedule
  key: node-role.kubernetes.io/control-plane
affinity:
  nodeAffinity:
  requiredDuringSchedulingIgnoredDuringExecution:
    nodeSelectorTerms:
      - matchExpressions:
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
      - matchExpressions:
          - key: node-role.kubernetes.io/master
            operator: Exists
</code></pre>
</blockquote>
<h2><a class="header" href="#validated-upgrade-paths-for-existing-clusters" id="validated-upgrade-paths-for-existing-clusters">Validated upgrade paths for existing clusters</a></h2>
<p>From Kubernetes 1.23 onwards, <code>CSIMigrationAWS</code> flag is enabled by default, which requires the installation of <a href="https://github.com/kubernetes-sigs/aws-ebs-csi-driver">external CSI driver</a>, unless <code>CSIMigrationAWS</code> is disabled by the user.
For installing external CSI/CCM in the upgraded cluster, CRS can be used, see the section above for details.</p>
<p>CCM and CSI do not need to be migrated to use external plugins at the same time,
external CSI drivers works with in-tree CCM (Warning: using in-tree CSI with external CCM does not work).</p>
<p><strong>Following 3 upgrade paths are validated:</strong></p>
<ul>
<li>Scenario 1: During upgrade to v1.23.x, disabling <code>CSIMigrationAWS</code> flag and keep using in-tree CCM and CSI.</li>
<li>Scenario 2: During upgrade to v1.23.x, enabling <code>CSIMigrationAWS</code> flag and using in-tree CCM with external CSI.</li>
<li>Scenario 3: During upgrade to v1.23.x, enabling <code>CSIMigrationAWS</code> flag and using external CCM and CSI.</li>
</ul>
<table><thead><tr><th></th><th>CSI</th><th>CCM</th><th>feature-gate CSIMigrationAWS</th><th>external-cloud-volume-plugin</th></tr></thead><tbody>
<tr><td><strong>Scenario 1</strong></td><td></td><td></td><td></td><td></td></tr>
<tr><td>From Kubernetes  &lt; v1.23</td><td>in-tree</td><td>in-tree</td><td>off</td><td>NA</td></tr>
<tr><td>To Kubernetes    &gt;= v1.23</td><td>in-tree</td><td>in-tree</td><td>off</td><td>NA</td></tr>
<tr><td><strong>Scenario 2</strong></td><td></td><td></td><td></td><td></td></tr>
<tr><td>From Kubernetes  &lt; v1.23</td><td>in-tree</td><td>in-tree</td><td>off</td><td>NA</td></tr>
<tr><td>To Kubernetes    &gt;= v1.23</td><td>external</td><td>in-tree</td><td>on</td><td>NA</td></tr>
<tr><td><strong>Scenario 3</strong></td><td></td><td></td><td></td><td></td></tr>
<tr><td>From Kubernetes  &lt; v1.23</td><td>in-tree</td><td>in-tree</td><td>off</td><td>NA</td></tr>
<tr><td>To Kubernetes    &gt;= v1.23</td><td>external</td><td>external</td><td>on</td><td>aws</td></tr>
</tbody></table>
<p><strong>KubeadmConfig in the upgraded cluster for scenario 1:</strong></p>
<pre><code>clusterConfiguration:
  apiServer:
    extraArgs:
      cloud-provider: aws
  controllerManager:
    extraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=false
initConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=false
    name: '{{ ds.meta_data.local_hostname }}'
joinConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=false
</code></pre>
<p><strong>KubeadmConfig in the upgraded cluster for scenario 2:</strong></p>
<p>When <code>CSIMigrationAWS=true</code>, installed external CSI driver will be used while relying on in-tree CCM.</p>
<pre><code>clusterConfiguration:
  apiServer:
    extraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=true   // Set only if Kubernetes version &lt; 1.23.x, otherwise this flag is enabled by default.
  controllerManager:
    extraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=true   // Set only if Kubernetes version &lt; 1.23.x, otherwise this flag is enabled by default.
initConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=true   // Set only if Kubernetes version &lt; 1.23.x, otherwise this flag is enabled by default.
joinConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: aws
      feature-gates: CSIMigrationAWS=true   // Set only if Kubernetes version &lt; 1.23.x, otherwise this flag is enabled by default.
</code></pre>
<p><strong>KubeadmConfig in the upgraded cluster for scenario 3:</strong></p>
<p><code>external-cloud-volume-plugin</code> flag needs to be set for old Kubelets to keep talking to in-tree CCM and upgrade fails without this is set.</p>
<pre><code>clusterConfiguration:
  apiServer:
    extraArgs:
      cloud-provider: external
  controllerManager:
    extraArgs:
      cloud-provider: external
      external-cloud-volume-plugin: aws
initConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: external
joinConfiguration:
  nodeRegistration:
    kubeletExtraArgs:
      cloud-provider: external
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../topics/specify-management-iam-role.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../topics/restricting-cluster-api-to-certain-namespaces.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../topics/specify-management-iam-role.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../topics/restricting-cluster-api-to-certain-namespaces.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
