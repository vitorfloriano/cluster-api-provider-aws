<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bring Your Own AWS Infrastructure - Kubernetes Cluster API Provider AWS</title>
        
        


        <!-- Custom HTML head -->
        <link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Lato:ital,wght@0,400;0,700;1,400;1,700&display=swap"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<meta name="google-site-verification" content="FGwibyytASqneHUQBmwzN0eOO3-Nd_coIx2YlbhzzSM" />


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../user/quick-start.html">Quick Start</a></li><li class="chapter-item expanded "><a href="../user/quick-start-operator.html">Quick Start Operator</a></li><li class="chapter-item expanded "><a href="../topics/images/amis.html">AMIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/images/built-amis.html">Published AMIs</a></li><li class="chapter-item expanded "><a href="../topics/images/custom-amis.html">Custom AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/index.html">Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/using-clusterawsadm-to-fulfill-prerequisites.html">Using clusterawsadm to fulfill prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/accessing-ec2-instances.html">Accessing EC2 instances</a></li><li class="chapter-item expanded "><a href="../topics/spot-instances.html">Spot instances</a></li><li class="chapter-item expanded "><a href="../topics/machinepools.html">Machine Pools</a></li><li class="chapter-item expanded "><a href="../topics/multitenancy.html">Multi-tenancy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/full-multitenancy-implementation.html">Multi-tenancy in EKS-managed clusters</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/eks/index.html">EKS Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/eks/prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/eks/enabling.html">Enabling EKS Support</a></li><li class="chapter-item expanded "><a href="../topics/eks/pod-networking.html">Pod Networking</a></li><li class="chapter-item expanded "><a href="../topics/eks/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/eks/disabling.html">Disabling</a></li><li class="chapter-item expanded "><a href="../topics/eks/eks-console.html">Using EKS Console</a></li><li class="chapter-item expanded "><a href="../topics/eks/addons.html">Using EKS Addons</a></li><li class="chapter-item expanded "><a href="../topics/eks/encryption.html">Enabling Encryption</a></li><li class="chapter-item expanded "><a href="../topics/eks/cluster-upgrades.html">Cluster Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/rosa/index.html">ROSA Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/rosa/enabling.html">Enabling ROSA Support</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-rosa-machinepools.html">Creating MachinePools</a></li><li class="chapter-item expanded "><a href="../topics/rosa/upgrades.html">Upgrades</a></li><li class="chapter-item expanded "><a href="../topics/rosa/external-auth.html">External Auth Providers</a></li><li class="chapter-item expanded "><a href="../topics/rosa/support.html">Support</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/bring-your-own-aws-infrastructure.html" class="active">Bring Your Own AWS Infrastructure</a></li><li class="chapter-item expanded "><a href="../topics/specify-management-iam-role.html">Specifying the IAM Role to use for Management Components</a></li><li class="chapter-item expanded "><a href="../topics/external-cloud-provider-with-ebs-csi-driver.html">Using external cloud provider with EBS CSI driver</a></li><li class="chapter-item expanded "><a href="../topics/restricting-cluster-api-to-certain-namespaces.html">Restricting Cluster API to certain namespaces</a></li><li class="chapter-item expanded "><a href="../topics/using-iam-roles-in-mgmt-cluster.html">Using IAM roles in management cluster instead of credentials</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/index.html">Failure domains</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/failure-domains/control-planes.html">Control planes</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/worker-nodes.html">Worker nodes</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/userdata-privacy.html">Userdata Privacy</a></li><li class="chapter-item expanded "><a href="../user/troubleshooting.html">Troubleshooting</a></li><li class="chapter-item expanded "><a href="../topics/iam-permissions.html">IAM Permissions Used</a></li><li class="chapter-item expanded "><a href="../topics/ignition-support.html">Ignition support</a></li><li class="chapter-item expanded "><a href="../topics/external-resource-gc.html">External Resource Garbage Collection</a></li><li class="chapter-item expanded "><a href="../topics/instance-metadata.html">Instance Metadata</a></li><li class="chapter-item expanded "><a href="../topics/network-load-balancer-with-awscluster.html">Network Load Balancers</a></li><li class="chapter-item expanded "><a href="../topics/secondary-load-balancer.html">Secondary Control Plane Load Balancer</a></li><li class="chapter-item expanded "><a href="../topics/provision-edge-zones.html">Provision AWS Local Zone subnets</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm.html">clusterawsadm command reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap.html">bootstrap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials.html">credentials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials_encode-as-profile.html">encode-as-profile</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam.html">iam</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-policy.html">print-policy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_create-cloudformation-stack.html">create-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_delete-cloudformation-stack.html">delete-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-cloudformation-template.html">print-cloudformation-template</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-config.html">print-config</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller.html">controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_print-credentials.html">print-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_rollout-controller.html">rollout-controller</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_update-credentials.html">update-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_zero-credentials.html">zero-credentials</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks.html">eks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons.html">addons</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-available.html">list-available</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-installed.html">list-installed</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc.html">gc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_configure.html">configure</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_disable.html">disable</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_enable.html">enable</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource.html">resource</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource_list.html">list</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_version.html">version</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami.html">ami</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_copy.html">copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_encrypted-copy.html">encrypted-copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_list.html">list</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../development/development.html">Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development/tilt-setup.html">Development with Tilt</a></li><li class="chapter-item expanded "><a href="../development/e2e.html">Developing E2E tests</a></li><li class="chapter-item expanded "><a href="../development/conventions.html">Coding Conventions</a></li><li class="chapter-item expanded "><a href="../development/nightlies.html">Try unreleased changes with Nightly Builds</a></li><li class="chapter-item expanded "><a href="../development/amis.html">Publishing AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../crd/index.html">CRD Reference</a></li><li class="chapter-item expanded "><a href="../topics/reference/reference.html">Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reference/glossary.html">Glossary</a></li><li class="chapter-item expanded "><a href="../topics/reference/ports.html">Ports</a></li><li class="chapter-item expanded "><a href="../topics/reference/jobs.html">Jobs</a></li><li class="chapter-item expanded "><a href="../topics/reference/versions.html">Version Support</a></li><li class="chapter-item expanded "><a href="../topics/reference/contributing.html">Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="../roadmap.html">Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Kubernetes Cluster API Provider AWS</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://sigs.k8s.io/cluster-api-provider-aws" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#bring-your-own-aws-infrastructure" id="bring-your-own-aws-infrastructure">Bring Your Own AWS Infrastructure</a></h1>
<p>Normally, Cluster API will create infrastructure on AWS when standing up a new workload cluster. However, it is possible to have Cluster API re-use external AWS infrastructure instead of creating its own infrastructure. </p>
<p>There are two possible ways to do this:</p>
<ul>
<li>By consuming existing AWS infrastructure</li>
<li>By using externally managed AWS infrastructure</li>
</ul>
<blockquote>
<p><strong>IMPORTANT NOTE</strong>: This externally managed AWS infrastructure should not be confused with EKS-managed clusters.</p>
</blockquote>
<p>Follow the instructions below to configure Cluster API to consume existing AWS infrastructure.</p>
<h2><a class="header" href="#consuming-existing-aws-infrastructure" id="consuming-existing-aws-infrastructure">Consuming Existing AWS Infrastructure</a></h2>
<h3><a class="header" href="#overview" id="overview">Overview</a></h3>
<p>CAPA supports using existing AWS resources while creating AWS Clusters which gives flexibility to the users to bring their own existing resources into the cluster instead of creating new resources again.</p>
<p>Follow the instructions below to configure Cluster API to consume existing AWS infrastructure.</p>
<h3><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h3>
<p>In order to have Cluster API consume existing AWS infrastructure, you will need to have already created the following resources:</p>
<ul>
<li>A VPC</li>
<li>One or more private subnets (subnets that do not have a route to an Internet gateway)</li>
<li>A NAT gateway for each private subnet, along with associated Elastic IP addresses (only needed if the nodes require access to the Internet, i.e. pulling public images)
<ul>
<li>A public subnet in the same Availability Zone (AZ) for each private subnet (this is required for NAT gateways to function properly)</li>
</ul>
</li>
<li>An Internet gateway for all public subnets (only required if the workload cluster is set to use an Internet facing load balancer or one or more NAT gateways exist in the VPC)</li>
<li>Route table associations that provide connectivity to the Internet through a NAT gateway (for private subnets) or the Internet gateway (for public subnets)</li>
<li>VPC endpoints for <code>ec2</code>, <code>elasticloadbalancing</code>, <code>secretsmanager</code> an <code>autoscaling</code> (if using MachinePools) when the private Subnets do not have a NAT gateway</li>
</ul>
<p>You will need the ID of the VPC and subnet IDs that Cluster API should use. This information is available via the AWS Management Console or the AWS CLI.</p>
<p>Note that there is no need to create an Elastic Load Balancer (ELB), security groups, or EC2 instances; Cluster API will take care of these items.</p>
<p>If you want to use existing security groups, these can be specified and new ones will not be created.</p>
<p>If you want to use an existing control load load balancer, specify its name.</p>
<h3><a class="header" href="#tagging-aws-resources" id="tagging-aws-resources">Tagging AWS Resources</a></h3>
<p>Cluster API itself does tag AWS resources it creates. The <code>sigs.k8s.io/cluster-api-provider-aws/cluster/&lt;cluster-name&gt;</code> (where <code>&lt;cluster-name&gt;</code> matches the <code>metadata.name</code> field of the Cluster object) tag, with a value of <code>owned</code>, tells Cluster API that it has ownership of the resource. In this case, Cluster API will modify and manage the lifecycle of the resource.</p>
<p>When consuming existing AWS infrastructure, the Cluster API AWS provider does not require any tags to be present. The absence of the tags on an AWS resource indicates to Cluster API that it should not modify the resource or attempt to manage the lifecycle of the resource.</p>
<p>However, the built-in Kubernetes AWS cloud provider <em>does</em> require certain tags in order to function properly. Specifically, all subnets where Kubernetes nodes reside should have the <code>kubernetes.io/cluster/&lt;cluster-name&gt;</code> tag present. Private subnets should also have the <code>kubernetes.io/role/internal-elb</code> tag with a value of 1, and public subnets should have the <code>kubernetes.io/role/elb</code> tag with a value of 1. These latter two tags help the cloud provider understand which subnets to use when creating load balancers.</p>
<p>Finally, if the controller manager isn’t started with the <code>--configure-cloud-routes: &quot;false&quot;</code> parameter, the route table(s) will also need the <code>kubernetes.io/cluster/&lt;cluster-name&gt;</code> tag. (This parameter can be added by customizing the <code>KubeadmConfigSpec</code> object of the <code>KubeadmControlPlane</code> object.)</p>
<blockquote>
<p><strong>Note</strong>: All the tagging of resources should be the responsibility of the users and are not managed by CAPA controllers.</p>
</blockquote>
<h3><a class="header" href="#configuring-the-awscluster-specification" id="configuring-the-awscluster-specification">Configuring the AWSCluster Specification</a></h3>
<p>Specifying existing infrastructure for Cluster API to use takes place in the specification for the AWSCluster object. Specifically, you will need to add an entry with the VPC ID and the IDs of all applicable subnets into the <code>network</code> field. Here is an example:</p>
<p>For EC2</p>
<pre><code class="language-yaml">apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: AWSCluster
</code></pre>
<p>For EKS</p>
<pre><code class="language-yaml">apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: AWSManagedControlPlane
</code></pre>
<pre><code class="language-yaml">spec:
  network:
    vpc:
      id: vpc-0425c335226437144
    subnets:
    - id: subnet-0261219d564bb0dc5
    - id: subnet-0fdcccba78668e013
</code></pre>
<p>When you use <code>kubectl apply</code> to apply the Cluster and AWSCluster specifications to the management cluster, Cluster API will use the specified VPC ID and subnet IDs, and will not create a new VPC, new subnets, or other associated resources. It <em>will</em>, however, create a new ELB and new security groups.</p>
<h3><a class="header" href="#placing-ec2-instances-in-specific-azs" id="placing-ec2-instances-in-specific-azs">Placing EC2 Instances in Specific AZs</a></h3>
<p>To distribute EC2 instances across multiple AZs, you can add information to the Machine specification. This is optional and only necessary if control over AZ placement is desired.</p>
<p>To tell Cluster API that an EC2 instance should be placed in a particular AZ but allow Cluster API to select which subnet in that AZ can be used, add this to the Machine specification:</p>
<pre><code class="language-yaml">spec:
  failureDomain: &quot;us-west-2a&quot;
</code></pre>
<p>If using a MachineDeployment, specify AZ placement like so:</p>
<pre><code class="language-yaml">spec:
  template:
    spec:
      failureDomain: &quot;us-west-2b&quot;
</code></pre>
<p>Note that all replicas within a MachineDeployment will reside in the same AZ.</p>
<h3><a class="header" href="#placing-ec2-instances-in-specific-subnets" id="placing-ec2-instances-in-specific-subnets">Placing EC2 Instances in Specific Subnets</a></h3>
<p>To specify that an EC2 instance should be placed in a specific subnet, add this to the AWSMachine specification:</p>
<pre><code class="language-yaml">spec:
  subnet:
    id: subnet-0a3507a5ad2c5c8c3
</code></pre>
<p>When using MachineDeployments, users can control subnet selection by adding information to the AWSMachineTemplate associated with that MachineDeployment, like this:</p>
<pre><code class="language-yaml">spec:
  template:
    spec:
      subnet:
        id: subnet-0a3507a5ad2c5c8c3
</code></pre>
<p>Users may either specify <code>failureDomain</code> on the Machine or MachineDeployment objects, <em>or</em> users may explicitly specify subnet IDs on the AWSMachine or AWSMachineTemplate objects. If both are specified, the subnet ID is used and the <code>failureDomain</code> is ignored.</p>
<h3><a class="header" href="#placing-ec2-instances-in-specific-external-vpcs" id="placing-ec2-instances-in-specific-external-vpcs">Placing EC2 Instances in Specific External VPCs</a></h3>
<p>CAPA clusters are deployed within a single VPC, but it’s possible to place machines that live in external VPCs. For this kind of configuration, we assume that all the VPCs have the ability to communicate, either through external peering, a transit gateway, or some other mechanism already established outside of CAPA. CAPA will not create a tunnel or manage the network configuration for any secondary VPCs.</p>
<p>The AWSMachineTemplate <code>subnet</code> field allows specifying filters or specific subnet ids for worker machine placement. If the filters or subnet id is specified in a secondary VPC, CAPA will place the machine in that VPC and subnet.</p>
<pre><code class="language-yaml">spec:
  template:
    spec:
      subnet:
        filters:
          name: &quot;vpc-id&quot;
          values:
            - &quot;secondary-vpc-id&quot;
      securityGroupOverrides:
        node: sg-04e870a3507a5ad2c5c8c2
        node-eks-additional: sg-04e870a3507a5ad2c5c8c1
</code></pre>
<h4><a class="header" href="#caveatsnotes" id="caveatsnotes">Caveats/Notes</a></h4>
<p>CAPA helpfully creates security groups for various roles in the cluster and automatically attaches them to workers. However, security groups are tied to a specific VPC, so workers placed in a VPC outside of the cluster will need to have these security groups created by some external process first and set in the <code>securityGroupOverrides</code> field, otherwise the ec2 creation will fail.</p>
<h3><a class="header" href="#security-groups" id="security-groups">Security Groups</a></h3>
<p>To use existing security groups for instances for a cluster, add this to the AWSCluster specification:</p>
<pre><code class="language-yaml">spec:
  network:
    securityGroupOverrides:
      bastion: sg-0350a3507a5ad2c5c8c3
      controlplane: sg-0350a3507a5ad2c5c8c3
      apiserver-lb: sg-0200a3507a5ad2c5c8c3
      node: sg-04e870a3507a5ad2c5c8c3
      lb: sg-00a3507a5ad2c5c8c3
</code></pre>
<p>Any additional security groups specified in an AWSMachineTemplate will be applied in addition to these overriden security groups.</p>
<p>To specify additional security groups for the control plane load balancer for a cluster, add this to the AWSCluster specification:</p>
<pre><code class="language-yaml">spec:
  controlPlaneLoadBalancer:
    additionalSecurityGroups:
    - sg-0200a3507a5ad2c5c8c3
    - ...
</code></pre>
<p>It’s also possible to override the cluster security groups for an individual AWSMachine or AWSMachineTemplate:</p>
<pre><code class="language-yaml">spec:
  SecurityGroupOverrides:
    node: sg-04e870a3507a5ad2c5c8c2
    node-eks-additional: sg-04e870a3507a5ad2c5c8c1
</code></pre>
<h3><a class="header" href="#control-plane-load-balancer" id="control-plane-load-balancer">Control Plane Load Balancer</a></h3>
<p>The cluster control plane is accessed through a Classic ELB. By default, Cluster API creates the Classic ELB. To use an existing Classic ELB, add its name to the AWSCluster specification:</p>
<pre><code class="language-yaml">spec:
  controlPlaneLoadBalancer:
    name: my-classic-elb-name
</code></pre>
<p>As control plane instances are added or removed, Cluster API will register and deregister them, respectively, with the Classic ELB.</p>
<p>It’s also possible to specify custom ingress rules for the control plane load balancer. To do so, add this to the AWSCluster specification:</p>
<pre><code class="language-yaml">spec:
  controlPlaneLoadBalancer:
    ingressRules:
      - description: &quot;example ingress rule&quot;
        protocol: &quot;-1&quot; # all
        fromPort: 7777
        toPort: 7777
</code></pre>
<blockquote>
<p><strong>WARNING:</strong> Using an existing Classic ELB is an advanced feature. <strong>If you use an existing Classic ELB, you must correctly configure it, and attach subnets to it.</strong></p>
<p>An incorrectly configured Classic ELB can easily lead to a non-functional cluster. We strongly recommend you let Cluster API create the Classic ELB.</p>
</blockquote>
<h3><a class="header" href="#control-plane-ingress-rules" id="control-plane-ingress-rules">Control Plane ingress rules</a></h3>
<p>It’s possible to specify custom ingress rules for the control plane itself. To do so, add this to the AWSCluster specification:</p>
<pre><code class="language-yaml">spec:
  network:
    additionalControlPlaneIngressRules:
    - description: &quot;example ingress rule&quot;
      protocol: &quot;-1&quot; # all
      fromPort: 7777
      toPort: 7777
</code></pre>
<h3><a class="header" href="#caveatsnotes-1" id="caveatsnotes-1">Caveats/Notes</a></h3>
<ul>
<li>When both public and private subnets are available in an AZ, CAPI will choose the private subnet in the AZ over the public subnet for placing EC2 instances.</li>
<li>If you configure CAPI to use existing infrastructure as outlined above, CAPI will <em>not</em> create an SSH bastion host. Combined with the previous bullet, this means you must make sure you have established some form of connectivity to the instances that CAPI will create.</li>
</ul>
<h2><a class="header" href="#using-externally-managed-aws-clusters" id="using-externally-managed-aws-clusters">Using Externally managed AWS Clusters</a></h2>
<h3><a class="header" href="#overview-1" id="overview-1">Overview</a></h3>
<p>Alternatively, CAPA supports externally managed cluster infrastructure which is useful for scenarios where a different persona is managing the cluster infrastructure out-of-band(external system) while still wanting to use CAPI for automated machine management.
Users can make use of existing AWSCluster CRDs in their externally managed clusters.</p>
<h3><a class="header" href="#how-to-use-externally-managed-clusters" id="how-to-use-externally-managed-clusters">How to use externally managed clusters?</a></h3>
<p>Users have to use <code>cluster.x-k8s.io/managed-by: &quot;&lt;name-of-system&gt;&quot;</code> annotation to depict that AWS resources are managed externally. If CAPA controllers come across this annotation in any of the AWS resources while reconciliation, then it will ignore the resource and not perform any reconciliation(including creating/modifying any of the AWS resources, or it’s status).</p>
<p>A predicate <code>ResourceIsNotExternallyManaged</code> is exposed by Cluster API which allows CAPA controllers to differentiate between externally managed vs CAPA managed resources. For example:</p>
<pre><code class="language-go">c, err := ctrl.NewControllerManagedBy(mgr).
        For(&amp;providerv1.InfraCluster{}).
        Watches(...).
        WithOptions(options).
        WithEventFilter(predicates.ResourceIsNotExternallyManaged(mgr.GetScheme(),logger.FromContext(ctx))).
        Build(r)
if err != nil {
	return errors.Wrap(err, &quot;failed setting up with a controller manager&quot;)
}
</code></pre>
<p>The external system must provide all required fields within the spec of the AWSCluster and must adhere to the CAPI provider contract and set the AWSCluster status to be ready when it is appropriate to do so.</p>
<blockquote>
<p><strong>IMPORTANT NOTE</strong>: Users should take care of skipping reconciliation in external controllers within mapping function while enqueuing requests. For example:</p>
<pre><code class="language-go">err := c.Watch(
  	&amp;source.Kind{Type: &amp;infrav1.AWSCluster{}},
  	handler.EnqueueRequestsFromMapFunc(func(a client.Object) []reconcile.Request {
  	   if annotations.IsExternallyManaged(awsCluster) {
  		    log.Info(&quot;AWSCluster is externally managed, skipping mapping.&quot;)
  		    return nil
  	   }
           return []reconcile.Request{
             {
  	         NamespacedName: client.ObjectKey{Namespace: c.Namespace, Name: c.Spec.InfrastructureRef.Name},
             },
          }}))
if err != nil {
   // handle it
}
</code></pre>
</blockquote>
<h3><a class="header" href="#caveats" id="caveats">Caveats</a></h3>
<p>Once the user has created externally managed AWSCluster, it is not allowed to convert it to CAPA managed cluster. However, converting from managed to externally managed is allowed.</p>
<p>User should only use this feature if their cluster infrastructure lifecycle management has constraints that the reference implementation does not support. See <a href="https://github.com/kubernetes-sigs/cluster-api/blob/10d89ceca938e4d3d94a1d1c2b60515bcdf39829/docs/proposals/20210203-externally-managed-cluster-infrastructure.md#user-stories">user stories</a> for more details.</p>
<h2><a class="header" href="#bring-your-own-byo-public-ipv4-addresses" id="bring-your-own-byo-public-ipv4-addresses">Bring your own (BYO) Public IPv4 addresses</a></h2>
<p>Cluster API provides a mechanism to allocate Elastic IPs from an existing Public IPv4 Pool that you brought to AWS[1].</p>
<p>Bringing your own Public IPv4 Pool (BYOIPv4) can serve as an alternative to purchasing Public IPs from AWS, especially considering the updated pricing model introduced in February 2024[2].</p>
<h3><a class="header" href="#supported-resources-for-byo-public-ipv4-pool" id="supported-resources-for-byo-public-ipv4-pool">Supported Resources for BYO Public IPv4 Pool</a></h3>
<p>The following resources can consume IPs from a BYO Public IPv4 Pool:</p>
<ul>
<li>NAT Gateways</li>
<li>Network Load Balancer for the API server</li>
<li>Machines</li>
</ul>
<p>Use <code>BYO Public IPv4</code> when you have custom IPv4 CIDR blocks advertised to AWS and want the cluster to automatically use IPs from the custom pool instead of Amazon-provided pools.</p>
<h3><a class="header" href="#prerequisites-and-limitations-for-byo-public-ipv4-pool" id="prerequisites-and-limitations-for-byo-public-ipv4-pool">Prerequisites and Limitations for BYO Public IPv4 Pool</a></h3>
<ul>
<li><strong>Regional Availability</strong>: BYOIPv4 is limited to selected AWS regions. Refer to <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-byoip.html#byoip-reg-avail">AWS Documentation for Regional Availability</a>.</li>
<li><strong>Provisioning and Advertising</strong>: IPv4 addresses must be provisioned and advertised to the AWS account before the cluster is installed.</li>
<li><strong>Network Border Group</strong>: Public IPv4 addresses are restricted to the network border group where the CIDR block has been advertised[3][4]. The <code>NetworkSpec.ElasticIpPool.PublicIpv4Pool</code> must match the cluster’s installation location.</li>
<li><strong>Resource Scope</strong>: Only NAT Gateways and the Network Load Balancer for the API server will consume IPs from the IPv4 pool defined in the network scope.</li>
<li><strong>Machine Assignment</strong>: Each machine must be assigned to the public IPv4 pool to consume IPs from the custom pool.</li>
</ul>
<h3><a class="header" href="#steps-to-configure-byo-public-ipv4-pool-for-core-infrastructure" id="steps-to-configure-byo-public-ipv4-pool-for-core-infrastructure">Steps to Configure BYO Public IPv4 Pool for Core Infrastructure</a></h3>
<p>CAPA supports BYO Public IPv4 for core components, including NAT Gateways and the Network Load Balancer for the internet-facing API server.</p>
<p>To specify a Public IPv4 Pool for core components, set the <code>spec.elasticIpPool</code> in the <code>AWSCluster</code> object:</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSCluster
metadata:
  name: aws-cluster-localzone
spec:
  region: us-east-1
  networkSpec:
    vpc:
      elasticIpPool:
        publicIpv4Pool: ipv4pool-ec2-0123456789abcdef0 # Custom IPv4 pool ID
        publicIpv4PoolFallbackOrder: amazon-pool       # Fallback to AWS-provided pool
</code></pre>
<p>All Elastic IPs will be created by consuming from the pool <code>ipv4pool-ec2-0123456789abcdef0</code>.</p>
<h3><a class="header" href="#steps-to-configure-byo-public-ipv4-pool-for-machines" id="steps-to-configure-byo-public-ipv4-pool-for-machines">Steps to Configure BYO Public IPv4 Pool for Machines</a></h3>
<p>To configure a machine to consume IPs from a custom Public IPv4 Pool, specify the pool ID in the <code>AWSMachine</code> spec and set <code>PublicIP</code> to <code>true</code>:</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSMachine
metadata:
  name: byoip-s55p4-bootstrap
spec:
  elasticIpPool:
    publicIpv4Pool: ipv4pool-ec2-0123456789abcdef0 # Custom IPv4 pool ID
    publicIpv4PoolFallbackOrder: amazon-pool       # Fallback to AWS-provided pool
  publicIP: true
</code></pre>
<h3><a class="header" href="#references" id="references">References</a></h3>
<p>[1] <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-byoip.html">AWS BYOIPv4 Documentation</a>
[2] <a href="https://aws.amazon.com/blogs/aws/new-aws-public-ipv4-address-charge-public-ip-insights/">AWS Blog: Public IPv4 Address Charges</a>
[3] <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-byoip.html#byoip-onboard">AWS BYOIPv4 Onboarding Guide</a>
[4] <a href="https://docs.aws.amazon.com/cli/latest/reference/ec2/advertise-byoip-cidr.html">AWS CLI: Advertise BYOIPv4 CIDR</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../topics/rosa/support.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../topics/specify-management-iam-role.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../topics/rosa/support.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../topics/specify-management-iam-role.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
