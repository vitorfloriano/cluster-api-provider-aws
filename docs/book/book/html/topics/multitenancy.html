<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Multi-tenancy - Kubernetes Cluster API Provider AWS</title>
        
        


        <!-- Custom HTML head -->
        <link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Lato:ital,wght@0,400;0,700;1,400;1,700&display=swap"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<meta name="google-site-verification" content="FGwibyytASqneHUQBmwzN0eOO3-Nd_coIx2YlbhzzSM" />


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../user/quick-start.html">Quick Start</a></li><li class="chapter-item expanded "><a href="../user/quick-start-operator.html">Quick Start Operator</a></li><li class="chapter-item expanded "><a href="../topics/images/amis.html">AMIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/images/built-amis.html">Published AMIs</a></li><li class="chapter-item expanded "><a href="../topics/images/custom-amis.html">Custom AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/index.html">Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/using-clusterawsadm-to-fulfill-prerequisites.html">Using clusterawsadm to fulfill prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/accessing-ec2-instances.html">Accessing EC2 instances</a></li><li class="chapter-item expanded "><a href="../topics/spot-instances.html">Spot instances</a></li><li class="chapter-item expanded "><a href="../topics/machinepools.html">Machine Pools</a></li><li class="chapter-item expanded "><a href="../topics/multitenancy.html" class="active">Multi-tenancy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/full-multitenancy-implementation.html">Multi-tenancy in EKS-managed clusters</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/eks/index.html">EKS Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/eks/prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded "><a href="../topics/eks/enabling.html">Enabling EKS Support</a></li><li class="chapter-item expanded "><a href="../topics/eks/pod-networking.html">Pod Networking</a></li><li class="chapter-item expanded "><a href="../topics/eks/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/eks/creating-a-cluster.html">Disabling</a></li><li class="chapter-item expanded "><a href="../topics/eks/eks-console.html">Using EKS Console</a></li><li class="chapter-item expanded "><a href="../topics/eks/addons.html">Using EKS Addons</a></li><li class="chapter-item expanded "><a href="../topics/eks/encryption.html">Enabling Encryption</a></li><li class="chapter-item expanded "><a href="../topics/eks/cluster-upgrades.html">Cluster Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/rosa/index.html">ROSA Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/rosa/enabling.html">Enabling ROSA Support</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../topics/rosa/creating-rosa-machinepools.html">Creating MachinePools</a></li><li class="chapter-item expanded "><a href="../topics/rosa/upgrades.html">Upgrades</a></li><li class="chapter-item expanded "><a href="../topics/rosa/external-auth.html">External Auth Providers</a></li><li class="chapter-item expanded "><a href="../topics/rosa/support.html">Support</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/bring-your-own-aws-infrastructure.html">Bring Your Own AWS Infrastructure</a></li><li class="chapter-item expanded "><a href="../topics/specify-management-iam-role.html">Specifying the IAM Role to use for Management Components</a></li><li class="chapter-item expanded "><a href="../topics/external-cloud-provider-with-ebs-csi-driver.html">Using external cloud provider with EBS CSI driver</a></li><li class="chapter-item expanded "><a href="../topics/restricting-cluster-api-to-certain-namespaces.html">Restricting Cluster API to certain namespaces</a></li><li class="chapter-item expanded "><a href="../topics/using-iam-roles-in-mgmt-cluster.html">Using IAM roles in management cluster instead of credentials</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/index.html">Failure domains</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../topics/failure-domains/control-planes.html">Control planes</a></li><li class="chapter-item expanded "><a href="../topics/failure-domains/worker-nodes.html">Worker nodes</a></li></ol></li><li class="chapter-item expanded "><a href="../topics/userdata-privacy.html">Userdata Privacy</a></li><li class="chapter-item expanded "><a href="../topics/troubleshooting.html">Troubleshooting</a></li><li class="chapter-item expanded "><a href="../topics/iam-permissions.html">IAM Permissions Used</a></li><li class="chapter-item expanded "><a href="../topics/ignition-support.html">Ignition support</a></li><li class="chapter-item expanded "><a href="../topics/external-resource-gc.html">External Resource Garbage Collection</a></li><li class="chapter-item expanded "><a href="../topics/instance-metadata.html">Instance Metadata</a></li><li class="chapter-item expanded "><a href="../topics/network-load-balancer-with-awscluster.html">Network Load Balancers</a></li><li class="chapter-item expanded "><a href="../topics/secondary-load-balancer.html">Secondary Control Plane Load Balancer</a></li><li class="chapter-item expanded "><a href="../topics/provision-edge-zones.html">Provision AWS Local Zone subnets</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm.html">clusterawsadm command reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap.html">bootstrap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials.html">credentials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_credentials_encode-as-profile.html">encode-as-profile</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam.html">iam</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-policy.html">print-policy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_create-cloudformation-stack.html">create-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_delete-cloudformation-stack.html">delete-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-cloudformation-template.html">print-cloudformation-template</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_bootstrap_iam_print-config.html">print-config</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller.html">controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_print-credentials.html">print-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_rollout-controller.html">rollout-controller</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_update-credentials.html">update-credentials</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_controller_zero-credentials.html">zero-credentials</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks.html">eks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons.html">addons</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-available.html">list-available</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_eks_addons_list-installed.html">list-installed</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc.html">gc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_configure.html">configure</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_disable.html">disable</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_gc_enable.html">enable</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource.html">resource</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_resource_list.html">list</a></li></ol></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_version.html">version</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami.html">ami</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_copy.html">copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_encrypted-copy.html">encrypted-copy</a></li><li class="chapter-item expanded "><a href="../clusterawsadm/clusterawsadm_ami_list.html">list</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../development/development.html">Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development/tilt-setup.html">Development with Tilt</a></li><li class="chapter-item expanded "><a href="../development/e2e.html">Developing E2E tests</a></li><li class="chapter-item expanded "><a href="../development/conventions.html">Coding Conventions</a></li><li class="chapter-item expanded "><a href="../development/nightlies.html">Try unreleased changes with Nightly Builds</a></li><li class="chapter-item expanded "><a href="../development/amis.html">Publishing AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../crd/index.html">CRD Reference</a></li><li class="chapter-item expanded "><a href="../topics/reference/reference.html">Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reference/glossary.html">Glossary</a></li><li class="chapter-item expanded "><a href="../topics/reference/ports.html">Ports</a></li><li class="chapter-item expanded "><a href="../topics/reference/jobs.html">Jobs</a></li><li class="chapter-item expanded "><a href="../topics/reference/versions.html">Version Support</a></li><li class="chapter-item expanded "><a href="../topics/reference/contributing.html">Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="../roadmap.html">Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Kubernetes Cluster API Provider AWS</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://sigs.k8s.io/cluster-api-provider-aws" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#multi-tenancy" id="multi-tenancy">Multi-tenancy</a></h1>
<p>Starting from v0.6.5, single controller multi-tenancy is supported that allows using a different AWS Identity for each workload cluster.
For details, see the <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/main/docs/proposal/20200506-single-controller-multitenancy.md">multi-tenancy proposal</a>.</p>
<p>For multi-tenancy support, a reference field (<code>identityRef</code>) is added to <code>AWSCluster</code>, which informs the controller of which identity to be used when reconciling the cluster.
If the identity provided exists in a different AWS account, this is the mechanism which informs the controller to provision a cluster in a different account.
Identities should have adequate permissions for CAPA to reconcile clusters.</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSCluster
metadata:
  name: &quot;test&quot;
  namespace: &quot;test&quot;
spec:
  region: &quot;eu-west-1&quot;
  identityRef:
    kind: &lt;IdentityType&gt;
    name: &lt;IdentityName&gt;
</code></pre>
<p>Identity resources are used to describe IAM identities that will be used during reconciliation.
There are three identity types: AWSClusterControllerIdentity, AWSClusterStaticIdentity, and AWSClusterRoleIdentity.
Once an IAM identity is created in AWS, the corresponding values should be used to create a identity resource.</p>
<h2><a class="header" href="#awsclustercontrolleridentity" id="awsclustercontrolleridentity">AWSClusterControllerIdentity</a></h2>
<p>Before multi-tenancy support, all AWSClusters were being reconciled using the credentials that are used by Cluster API Provider AWS Controllers.
<code>AWSClusterControllerIdentity</code> is used to restrict the usage of controller credentials only to AWSClusters that are in <code>allowedNamespaces</code>.
Since CAPA controllers use a single set of credentials, <code>AWSClusterControllerIdentity</code> is a singleton, and can only be created with <code>name: default</code>.</p>
<p>For backward compatibility, <code>AutoControllerIdentityCreator</code> experimental feature is added, which is responsible to create the <code>AWSClusterControllerIdentity</code> singleton if it does not exist.</p>
<ul>
<li><strong>Feature status:</strong> Experimental</li>
<li><strong>Feature gate:</strong> AutoControllerIdentityCreator=true
<code>AutoControllerIdentityCreator</code> creates <code>AWSClusterControllerIdentity</code> singleton with empty <code>allowedNamespaces</code> (allowedNamespaces: {}) to grant access to the <code>AWSClusterControllerIdentity</code> from all namespaces.</li>
</ul>
<p>Example:</p>
<pre><code class="language-yaml">---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSCluster
metadata:
  name: &quot;test&quot;
  namespace: &quot;test&quot;
spec:
  region: &quot;eu-west-1&quot;
  identityRef:
    kind: AWSClusterControllerIdentity
    name: default
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterControllerIdentity
metadata:
  name: &quot;default&quot;
spec:
  allowedNamespaces: {}  # matches all namespaces
</code></pre>
<p><code>AWSClusterControllerIdentity</code> is immutable to avoid any unwanted overrides to the allowed namespaces, especially during upgrading clusters.</p>
<h2><a class="header" href="#awsclusterstaticidentity" id="awsclusterstaticidentity">AWSClusterStaticIdentity</a></h2>
<p><code>AWSClusterStaticIdentity</code> represents static AWS credentials, which are stored in a <code>Secret</code>.</p>
<p>Example: Below, an <code>AWSClusterStaticIdentity</code> is created that allows access to the <code>AWSClusters</code> that are in “test” namespace.
The identity credentials that will be used by “test” AWSCluster are stored in “test-account-creds” secret.</p>
<pre><code class="language-yaml">---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSCluster
metadata:
  name: &quot;test&quot;
  namespace: &quot;test&quot;
spec:
  region: &quot;eu-west-1&quot;
  identityRef:
    kind: AWSClusterStaticIdentity
    name: test-account
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterStaticIdentity
metadata:
  name: &quot;test-account&quot;
spec:
  secretRef: test-account-creds
  allowedNamespaces:
    selector:
      matchLabels:
        cluster.x-k8s.io/ns: &quot;testlabel&quot;
---
apiVersion: v1
kind: Namespace
metadata:
  labels:
    cluster.x-k8s.io/ns: &quot;testlabel&quot;
  name: &quot;test&quot;
---
apiVersion: v1
kind: Secret
metadata:
  name: &quot;test-account-creds&quot;
  namespace: capa-system
stringData:
 AccessKeyID: AKIAIOSFODNN7EXAMPLE
 SecretAccessKey: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
</code></pre>
<h2><a class="header" href="#awsclusterroleidentity" id="awsclusterroleidentity">AWSClusterRoleIdentity</a></h2>
<p><code>AWSClusterRoleIdentity</code> allows CAPA to assume a role either in the same or another AWS account, using the STS::AssumeRole API.
The assumed role could be used by the AWSClusters that is in the <code>allowedNamespaces</code>.</p>
<p>Example:
Below, an <code>AWSClusterRoleIdentity</code> instance, which will be used by <code>AWSCluster</code> “test”, is created.
This role will be assumed by the source identity at runtime. Source identity can be of any identity type.
Role is assumed in the beginning once and after, whenever the assumed role’s credentials are expired.</p>
<p>This snippet illustrates the connection between <code>AWSCluster</code>and the <code>AWSClusterRoleIdentity</code>, however this is not a working example.
Please view a full example below.</p>
<pre><code class="language-yaml">---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSCluster
metadata:
  name: &quot;test&quot;
  namespace: &quot;test&quot;
spec:
  region: &quot;eu-west-1&quot;
  identityRef:
    kind: AWSClusterRoleIdentity
    name: test-account-role
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterRoleIdentity
metadata:
  name: &quot;test-account-role&quot;
spec:
  allowedNamespaces:
  - &quot;test&quot; # allows only &quot;test&quot; namespace to use this identity
  roleARN: &quot;arn:aws:iam::123456789:role/CAPARole&quot;
  sourceIdentityRef:
    kind: AWSClusterControllerIdentity # use the singleton for root auth
    name: default
</code></pre>
<p>Nested role assumption is also supported.
Example: Below, “multi-tenancy-nested-role” will be assumed by “multi-tenancy-role”, which will be assumed by the “default” <code>AWSClusterControllerIdentity</code></p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterRoleIdentity
metadata:
  name: multi-tenancy-role
spec:
  allowedNamespaces:
    list: []
  durationSeconds: 900 # default and min value is 900 seconds
  roleARN: arn:aws:iam::11122233344:role/multi-tenancy-role
  sessionName: multi-tenancy-role-session
  sourceIdentityRef:
    kind: AWSClusterControllerIdentity
    name: default
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterRoleIdentity
metadata:
  name: multi-tenancy-nested-role
spec:
  allowedNamespaces:
    list: []
  roleARN: arn:aws:iam::11122233355:role/multi-tenancy-nested-role
  sessionName: multi-tenancy-nested-role-session
  sourceIdentityRef:
    kind: AWSClusterRoleIdentity
    name: multi-tenancy-role
</code></pre>
<h3><a class="header" href="#necessary-permissions-for-assuming-a-role" id="necessary-permissions-for-assuming-a-role">Necessary permissions for assuming a role:</a></h3>
<p>There are multiple AWS assume role permissions that need to be configured in order for the assume role to work:</p>
<ul>
<li>
<p>The source identity (user/role specified in the source identity field) should have IAM policy permissions that enable it to perform sts:AssumeRole operation.</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;sts:AssumeRole&quot;,
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>
</li>
<li>
<p>The target role (can be in a different AWS account) must be configured to allow the source user/role (or all users in an AWS account) to assume into it by setting a trust policy:</p>
<pre><code class="language-json">{
&quot;Version&quot;: &quot;2012-10-17&quot;,
&quot;Statement&quot;: [
  {
    &quot;Effect&quot;: &quot;Allow&quot;,
    &quot;Principal&quot;: {
      &quot;AWS&quot;: &quot;arn:aws:iam::111111111111:root&quot;
        // &quot;AWS&quot;: &quot;arn:aws:iam::111111111111:role/role-used-during-cluster-bootstrap&quot;
    },
    &quot;Action&quot;: &quot;sts:AssumeRole&quot;
  }
]
}
</code></pre>
</li>
</ul>
<p>Both of these permissions can be enabled via clusterawsadm as documented <a href="using-clusterawsadm-to-fulfill-prerequisites.html#cross-account-role-assumption">here</a>.</p>
<h3><a class="header" href="#examples" id="examples">Examples</a></h3>
<p>This is a deployable example which uses the <code>AWSClusterRoleIdentity</code> “test-account-role” to assume into the <code>arn:aws:iam::123456789:role/CAPARole</code> role in the target account.
This example assumes that the <code>CAPARole</code> has already been configured in the target account.</p>
<p>Finally, we inform the <code>Cluster</code> to use our <code>AWSCluster</code>type to provision a cluster in the target account specified by the <code>identityRef</code> section.</p>
<p><strong>Note</strong></p>
<p>By default the <code>AutoControllerIdentityCreator=true</code> feature gate is set to <code>true</code> <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/412d310654c6b05f1b4bc3d319f6957a07c009c2/feature/feature.go?rgh-link-date=2022-03-23T14%3A57%3A46Z#L81">here</a>.
If this is not enabled for your cluster, you will need to enable the flag, or create your own default <code>AWSClusterControllerIdentity</code>.</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterControllerIdentity
metadata:
  name: &quot;default&quot;
spec:
  allowedNamespaces: {}  # matches all namespaces
</code></pre>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterRoleIdentity
metadata:
  name: &quot;test-account-role&quot;
spec:
  allowedNamespaces: {} # matches all namespaces
  roleARN: &quot;arn:aws:iam::123456789:role/CAPARole&quot;
  sourceIdentityRef:
    kind: AWSClusterControllerIdentity # use the singleton for root auth
    name: default
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSCluster
metadata:
  name: &quot;test-multi-tenant-workload&quot;
spec:
  region: &quot;eu-west-1&quot;
  identityRef:
    kind: AWSClusterRoleIdentity
    name: test-account-role
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: &quot;test-multi-tenant-workload&quot;
spec:
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
    kind: AWSCluster
    name: &quot;test-multi-tenant-workload&quot;
</code></pre>
<p>More specific examples can be referenced from the existing <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/main/templates/">templates</a> directory.</p>
<p>In order to use the <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/main/templates/cluster-template.yaml">EC2 template</a> with identity type, you can add the <code>identityRef</code> section to <code>kind: AWSCluster</code> spec section in the template. If you do not, CAPA will automatically add the default identity provider (which is usually your local account credentials).</p>
<p>Similarly, to use the <a href="https://github.com/kubernetes-sigs/cluster-api-provider-aws/blob/main/templates/cluster-template-eks.yaml">EKS template</a> with identity type, you can add the <code>identityRef</code> section to <code>kind: AWSManagedControlPlane</code> spec section in the template. If you do not, CAPA will automatically add the default identity provider (which is usually your local account credentials).</p>
<h2><a class="header" href="#secure-access-to-identities" id="secure-access-to-identities">Secure Access to Identities</a></h2>
<p><code>allowedNamespaces</code> field is used to grant access to the namespaces to use Identities.
Only AWSClusters that are created in one of the Identity’s allowed namespaces can use that Identity.
<code>allowedNamespaces</code> are defined by providing either a list of namespaces or label selector to select namespaces.</p>
<h3><a class="header" href="#examples-1" id="examples-1">Examples</a></h3>
<p>An empty <code>allowedNamespaces</code> indicates that the Identity can be used by all namespaces.</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterControllerIdentity
spec:
  allowedNamespaces:{}  # matches all namespaces
</code></pre>
<p>Having a nil <code>list</code> and a nil <code>selector</code> is the same with having an empty <code>allowedNamespaces</code> (Identity can be used by all namespaces).</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterControllerIdentity
spec:
  allowedNamespaces:
    list: nil
    selector: nil
</code></pre>
<p>A nil <code>allowedNamespaces</code> indicates that the Identity cannot be used from any namespace.</p>
<pre><code class="language-yaml">apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterControllerIdentity
spec:
  allowedNamespaces:  # this is same with not providing the field at all or allowedNamespaces: null
</code></pre>
<p>The union of namespaces that are matched by <code>selector</code> and the namespaces that are in the <code>list</code> is granted access to the identity.
The namespaces that are not in the list and not matching the selector will not have access.</p>
<p>Nil or empty <code>list</code> matches no namespaces. Nil or empty <code>selector</code> matches no namespaces.
If <code>list</code> is nil and <code>selector</code> is empty OR <code>list</code> is empty and <code>selector</code> is nil, Identity cannot be used from any namespace.
Because in this case, <code>allowedNamespaces</code> is not empty or nil, and neither <code>list</code> nor <code>selector</code> allows any namespaces, so the union is empty.</p>
<pre><code class="language-yaml"># Matches no namespaces
allowedNamespaces:
  list: []
</code></pre>
<pre><code class="language-yaml"># Matches no namespaces
allowedNamespaces:
  selector: {}
</code></pre>
<pre><code class="language-yaml"># Matches no namespaces
allowedNamespaces:
  list: null
  selector: {}
</code></pre>
<pre><code class="language-yaml"># Matches no namespaces
allowedNamespaces:
  list: []
  selector: {}
</code></pre>
<p><strong>Important</strong> The default behaviour of an empty label selector is to match all objects, however here we do not follow that behavior to avoid unintended access to the identities.
This is consistent with core cluster API selectors, e.g., Machine and ClusterResourceSet selectors. The result of matchLabels and matchExpressions are ANDed.</p>
<p>In Kubernetes selectors, <code>matchLabels</code> and <code>matchExpressions</code> are ANDed.
In the example below, list is empty/nil, so does not allow any namespaces and selector matches with only <code>default</code> namespace.
Since <code>list</code> and <code>selector</code> results are ORed, <code>default</code> namespace can use this identity.</p>
<pre><code class="language-yaml">kind: namespace
metadata:
  name: default
  labels:
    environment: dev
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: AWSClusterControllerIdentity
spec:
  allowedNamespaces:
    list: null # or []
    selector:
      matchLabels:
        namespace: default
      matchExpressions:
        - {key: environment, operator: In, values: [dev]}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../topics/machinepools.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../topics/full-multitenancy-implementation.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../topics/machinepools.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../topics/full-multitenancy-implementation.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
