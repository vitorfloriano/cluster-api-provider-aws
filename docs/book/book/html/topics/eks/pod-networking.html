<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pod Networking - Kubernetes Cluster API Provider AWS</title>
        
        


        <!-- Custom HTML head -->
        <link
  href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Lato:ital,wght@0,400;0,700;1,400;1,700&display=swap"
  rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<meta name="google-site-verification" content="FGwibyytASqneHUQBmwzN0eOO3-Nd_coIx2YlbhzzSM" />


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../../quick-start.html">Quick Start</a></li><li class="chapter-item expanded "><a href="../../quick-start-operator.html">Quick Start Operator</a></li><li class="chapter-item expanded "><a href="../../topics/images/amis.html">AMIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/images/built-amis.html">Published AMIs</a></li><li class="chapter-item expanded "><a href="../../topics/images/custom-amis.html">Custom AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/index.html">Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/using-clusterawsadm-to-fulfill-prerequisites.html">Using clusterawsadm to fulfill prerequisites</a></li><li class="chapter-item expanded "><a href="../../topics/accessing-ec2-instances.html">Accessing EC2 instances</a></li><li class="chapter-item expanded "><a href="../../topics/spot-instances.html">Spot instances</a></li><li class="chapter-item expanded "><a href="../../topics/machinepools.html">Machine Pools</a></li><li class="chapter-item expanded "><a href="../../topics/multitenancy.html">Multi-tenancy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/full-multitenancy-implementation.html">Multi-tenancy in EKS-managed clusters</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/eks/index.html">EKS Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/eks/prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded "><a href="../../topics/eks/enabling.html">Enabling EKS Support</a></li><li class="chapter-item expanded "><a href="../../topics/eks/pod-networking.html" class="active">Pod Networking</a></li><li class="chapter-item expanded "><a href="../../topics/eks/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../../topics/eks/eks-console.html">Using EKS Console</a></li><li class="chapter-item expanded "><a href="../../topics/eks/addons.html">Using EKS Addons</a></li><li class="chapter-item expanded "><a href="../../topics/eks/encryption.html">Enabling Encryption</a></li><li class="chapter-item expanded "><a href="../../topics/eks/cluster-upgrades.html">Cluster Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/rosa/index.html">ROSA Support</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/rosa/enabling.html">Enabling ROSA Support</a></li><li class="chapter-item expanded "><a href="../../topics/rosa/creating-a-cluster.html">Creating a cluster</a></li><li class="chapter-item expanded "><a href="../../topics/rosa/creating-rosa-machinepools.html">Creating MachinePools</a></li><li class="chapter-item expanded "><a href="../../topics/rosa/upgrades.html">Upgrades</a></li><li class="chapter-item expanded "><a href="../../topics/rosa/external-auth.html">External Auth Providers</a></li><li class="chapter-item expanded "><a href="../../topics/rosa/support.html">Support</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/bring-your-own-aws-infrastructure.html">Bring Your Own AWS Infrastructure</a></li><li class="chapter-item expanded "><a href="../../topics/specify-management-iam-role.html">Specifying the IAM Role to use for Management Components</a></li><li class="chapter-item expanded "><a href="../../topics/external-cloud-provider-with-ebs-csi-driver.html">Using external cloud provider with EBS CSI driver</a></li><li class="chapter-item expanded "><a href="../../topics/restricting-cluster-api-to-certain-namespaces.html">Restricting Cluster API to certain namespaces</a></li><li class="chapter-item expanded "><a href="../../topics/using-iam-roles-in-mgmt-cluster.html">Using IAM roles in management cluster instead of credentials</a></li><li class="chapter-item expanded "><a href="../../topics/failure-domains/index.html">Failure domains</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/failure-domains/control-planes.html">Control planes</a></li><li class="chapter-item expanded "><a href="../../topics/failure-domains/worker-nodes.html">Worker nodes</a></li></ol></li><li class="chapter-item expanded "><a href="../../topics/userdata-privacy.html">Userdata Privacy</a></li><li class="chapter-item expanded "><a href="../../topics/troubleshooting.html">Troubleshooting</a></li><li class="chapter-item expanded "><a href="../../topics/iam-permissions.html">IAM Permissions Used</a></li><li class="chapter-item expanded "><a href="../../topics/ignition-support.html">Ignition support</a></li><li class="chapter-item expanded "><a href="../../topics/external-resource-gc.html">External Resource Garbage Collection</a></li><li class="chapter-item expanded "><a href="../../topics/instance-metadata.html">Instance Metadata</a></li><li class="chapter-item expanded "><a href="../../topics/network-load-balancer-with-awscluster.html">Network Load Balancers</a></li><li class="chapter-item expanded "><a href="../../topics/secondary-load-balancer.html">Secondary Control Plane Load Balancer</a></li><li class="chapter-item expanded "><a href="../../topics/provision-edge-zones.html">Provision AWS Local Zone subnets</a></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm.html">clusterawsadm command reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap.html">bootstrap</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_credentials.html">credentials</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_credentials_encode-as-profile.html">encode-as-profile</a></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_iam.html">iam</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_iam_print-config.html">print-config</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_iam_print-policy.html">print-policy</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_iam_create-cloudformation-stack.html">create-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_iam_delete-cloudformation-stack.html">delete-cloudformation-stack</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_bootstrap_iam_print-cloudformation-template.html">print-cloudformation-template</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_controller.html">controller</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_controller_print-credentials.html">print-credentials</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_controller_rollout-controller.html">rollout-controller</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_controller_update-credentials.html">update-credentials</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_controller_zero-credentials.html">zero-credentials</a></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_eks.html">eks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_eks_addons.html">addons</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_eks_addons_list-available.html">list-available</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_eks_addons_list-installed.html">list-installed</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_gc.html">gc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_gc_configure.html">configure</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_gc_disable.html">disable</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_gc_enable.html">enable</a></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_resource.html">resource</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_resource_list.html">list</a></li></ol></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_version.html">version</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_ami.html">ami</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_ami_copy.html">copy</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_ami_encrypted-copy.html">encrypted-copy</a></li><li class="chapter-item expanded "><a href="../../clusterawsadm/clusterawsadm_ami_list.html">list</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../development/development.html">Developer Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../development/tilt-setup.html">Development with Tilt</a></li><li class="chapter-item expanded "><a href="../../development/e2e.html">Developing E2E tests</a></li><li class="chapter-item expanded "><a href="../../development/conventions.html">Coding Conventions</a></li><li class="chapter-item expanded "><a href="../../development/nightlies.html">Try unreleased changes with Nightly Builds</a></li><li class="chapter-item expanded "><a href="../../development/amis.html">Publishing AMIs</a></li></ol></li><li class="chapter-item expanded "><a href="../../crd/index.html">CRD Reference</a></li><li class="chapter-item expanded "><a href="../../topics/reference/reference.html">Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../topics/reference/glossary.html">Glossary</a></li><li class="chapter-item expanded "><a href="../../topics/reference/ports.html">Ports</a></li><li class="chapter-item expanded "><a href="../../topics/reference/jobs.html">Jobs</a></li><li class="chapter-item expanded "><a href="../../topics/reference/versions.html">Version Support</a></li><li class="chapter-item expanded "><a href="../../topics/reference/contributing.html">Contributing</a></li></ol></li><li class="chapter-item expanded "><a href="../../roadmap.html">Roadmap</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Kubernetes Cluster API Provider AWS</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://sigs.k8s.io/cluster-api-provider-aws" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#pod-networking" id="pod-networking">Pod Networking</a></h1>
<p>When creating a EKS cluster the Amazon VPC CNI will be used by default for Pod Networking.</p>
<blockquote>
<p>When using the AWS Console to create an EKS cluster with a Kubernetes version of v1.18 or greater you are required to select a specific version of the VPC CNI to use.</p>
</blockquote>
<h2><a class="header" href="#using-the-vpc-cni-addon" id="using-the-vpc-cni-addon">Using the VPC CNI Addon</a></h2>
<p>You can use an explicit version of the Amazon VPC CNI by using the <strong>vpc-cni</strong> EKS addon. See the <a href="./addons.html">addons</a> documentation for further details of how to use addons.</p>
<h2><a class="header" href="#using-custom-vpc-cni-configuration" id="using-custom-vpc-cni-configuration">Using Custom VPC CNI Configuration</a></h2>
<p>If your use case demands <a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-custom-network.html">custom networking</a> VPC CNI configuration you might already be familiar with the <a href="https://github.com/aws/amazon-vpc-cni-k8s">helm chart</a> which helps with the process. This gives you access to ENI Configs and you can set Environment Variables on the <code>aws-node</code> DaemonSet where the VPC CNI runs. CAPA is able to tune the same DaemonSet through Kubernetes.</p>
<p>The following example shows how to turn on custom network config and set a <a href="https://github.com/aws/amazon-vpc-cni-k8s#eni_config_label_def">label definition</a>.</p>
<pre><code class="language-yaml">kind: AWSManagedControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: &quot;capi-managed-test-control-plane&quot;
spec:
  vpcCni:
    env:
    - name: AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG
      value: &quot;true&quot; 
    - name: ENABLE_PREFIX_DELEGATION
      value: &quot;true&quot;
</code></pre>
<h3><a class="header" href="#increase-node-pod-limit" id="increase-node-pod-limit">Increase node pod limit</a></h3>
<p>You can increase the pod limit per-node as <a href="https://aws.amazon.com/blogs/containers/amazon-vpc-cni-increases-pods-per-node-limits/">per the upstream AWS documentation</a>. Youâ€™ll need to enable the <code>vpc-cni</code> plugin addon on your EKS cluster as well as enable prefix assignment mode through the <code>ENABLE_PREFIX_DELEGATION</code> environment variable.</p>
<pre><code class="language-yaml">kind: AWSManagedControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: &quot;capi-managed-test-control-plane&quot;
spec:
  vpcCni:
    env:
    - name: AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG
      value: &quot;true&quot; 
    - name: ENABLE_PREFIX_DELEGATION
      value: &quot;true&quot;
  addons:
  - name: vpc-cni
    version: &lt;replace_with_version&gt;
    conflictResolution: overwrite
  associateOIDCProvider: true
  disableVPCCNI: false
</code></pre>
<h3><a class="header" href="#using-secondary-cidrs" id="using-secondary-cidrs">Using Secondary CIDRs</a></h3>
<p>EKS allows users to assign a <a href="https://www.eksworkshop.com/beginner/160_advanced-networking/secondary_cidr/">secondary CIDR range</a> for pods to be  assigned. Below are how to get CAPA to generate ENIConfigs in both the managed and unmanaged VPC configurations. </p>
<blockquote>
<p>Secondary CIDR functionality will not work unless you enable custom network config too.</p>
</blockquote>
<h4><a class="header" href="#managed-dynamic-vpc" id="managed-dynamic-vpc">Managed (dynamic) VPC</a></h4>
<p>Default configuration for CAPA is to manage the VPC and all the subnets for you dynamically. It will create and delete them along with your cluster. In this method all you need to do is set a SecondaryCidrBlock to one of the allowed two IPv4 CIDR blocks: 100.64.0.0/10 and 198.19.0.0/16. CAPA will automatically generate subnets and ENIConfigs for you and the VPC CNI will do the rest.</p>
<pre><code class="language-yaml">kind: AWSManagedControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: &quot;capi-managed-test-control-plane&quot;
spec:
  secondaryCidrBlock: 100.64.0.0/10
  vpcCni:
    env:
    - name: AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG
      value: &quot;true&quot; 
  
</code></pre>
<h4><a class="header" href="#unmanaged-static-vpc" id="unmanaged-static-vpc">Unmanaged (static) VPC</a></h4>
<p>In an unmanaged VPC configuration CAPA will create no VPC or subnets and will instead assign the cluster pieces to the IDs you pass. In order to get ENIConfigs to generate you will need to add tags to the subnet you created and want to use as the secondary subnets for your pods. This is done through tagging the subnets with the following tag: <code>sigs.k8s.io/cluster-api-provider-aws/association=secondary</code>.</p>
<blockquote>
<p>Setting <code>SecondaryCidrBlock</code> in this configuration will be ignored and no subnets are created.</p>
</blockquote>
<h2><a class="header" href="#using-an-alternative-cni" id="using-an-alternative-cni">Using an alternative CNI</a></h2>
<p>There may be scenarios where you do not want to use the Amazon VPC CNI. EKS supports a number of alternative CNIs such as Calico, Cilium, and Weave Net (see <a href="https://docs.aws.amazon.com/eks/latest/userguide/alternate-cni-plugins.html">docs</a> for full list).</p>
<p>There are a number of ways to install an alternative CNI into the cluster. One option is to use a <a href="https://cluster-api.sigs.k8s.io/tasks/experimental-features/cluster-resource-set.html">ClusterResourceSet</a> to apply the required artifacts to a newly provisioned cluster.</p>
<p>When using an alternative CNI you will want to delete the Amazon VPC CNI, especially for a cluster using v1.17 or less. This can be done via the <strong>disableVPCCNI</strong> property of the <strong>AWSManagedControlPlane</strong>:</p>
<pre><code class="language-yaml">kind: AWSManagedControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: &quot;capi-managed-test-control-plane&quot;
spec:
  region: &quot;eu-west-2&quot;
  sshKeyName: &quot;capi-management&quot;
  version: &quot;v1.18.0&quot;
  disableVPCCNI: true
</code></pre>
<p>If you are replacing Amazon VPC CNI with your own helm managed instance, you will need to set <code>AWSManagedControlPlane.spec.disableVPCCNI</code> to <code>true</code> and add <code>&quot;aws.cluster.x-k8s.io/prevent-deletion&quot;: &quot;true&quot;</code> label on the Daemonset. This label is needed so <code>aws-node</code> daemonset is not reaped during CNI reconciliation.</p>
<p>The following example shows how to label your aws-node Daemonset.</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: DaemonSet
metadata:
  annotations:
    ...
  generation: 1
  labels:
    app.kubernetes.io/instance: aws-vpc-cni
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: aws-node
    app.kubernetes.io/version: v1.15.1
    helm.sh/chart: aws-vpc-cni-1.15.1
    aws.cluster.x-k8s.io/prevent-deletion: true
</code></pre>
<blockquote>
<p>You cannot set <strong>disableVPCCNI</strong> to true if you are using the VPC CNI addon.</p>
</blockquote>
<p>Some alternative CNIs provide for the replacement of kube-proxy, such as in <a href="https://projectcalico.docs.tigera.io/maintenance/ebpf/enabling-ebpf#configure-kube-proxy">Calico</a> and <a href="https://docs.cilium.io/en/stable/gettingstarted/kubeproxy-free/">Cilium</a>. When enabling the kube-proxy alternative, the kube-proxy installed by EKS must be deleted. This can be done via the <strong>disable</strong> property of <strong>kubeProxy</strong> in <strong>AWSManagedControlPlane</strong>:</p>
<pre><code class="language-yaml">kind: AWSManagedControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: &quot;capi-managed-test-control-plane&quot;
spec:
  region: &quot;eu-west-2&quot;
  sshKeyName: &quot;capi-management&quot;
  version: &quot;v1.18.0&quot;
  disableVPCCNI: true
  kubeProxy:
    disable: true
</code></pre>
<blockquote>
<p>You cannot set <strong>disable</strong> to true in <strong>kubeProxy</strong> if you are using the kube-proxy addon.</p>
</blockquote>
<h2><a class="header" href="#additional-information" id="additional-information">Additional Information</a></h2>
<p>See the <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html">AWS documentation</a> for further details of EKS pod networking.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../topics/eks/enabling.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../topics/eks/creating-a-cluster.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../topics/eks/enabling.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../topics/eks/creating-a-cluster.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
